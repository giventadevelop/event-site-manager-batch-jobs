spring:
  application:
    name: event-site-manager-batch-jobs

  datasource:
    url: jdbc:postgresql://${RDS_ENDPOINT:localhost}:5432/${DB_NAME:event_site_manager_db}
    username: ${DB_USERNAME:event_site_app}
    password: ${DB_PASSWORD}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: ${DB_MAX_POOL_SIZE:10}
      minimum-idle: ${DB_MIN_IDLE:2}
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000

  jpa:
    hibernate:
      ddl-auto: update  # Use 'update' for development, 'validate' for production after tables are created
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
        jdbc:
          batch_size: 50
        order_inserts: true
        order_updates: true

  batch:
    job:
      enabled: false  # Jobs are triggered via REST API or scheduled tasks
    jdbc:
      initialize-schema: never  # Set to 'never' since we're manually creating tables with BIGSERIAL
      table-prefix: BATCH_

  cache:
    # Use Caffeine as primary cache implementation (same pattern as main backend)
    type: caffeine
    caffeine:
      spec: maximumSize=1000,expireAfterWrite=3600s

server:
  port: ${SERVER_PORT:8081}  # Default to 8081 to avoid conflict with backend on 8080
  servlet:
    context-path: /batch-jobs

management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus,metrics
  endpoint:
    health:
      show-details: when-authorized
  metrics:
    export:
      prometheus:
        enabled: true

# Cache TTL configuration for named caches (seconds)
cache:
  ttl:
    tenantFooterHtml: 3600   # 1 hour - tenant footer HTML from S3
    tenantEmailFrom: 3600    # 1 hour - resolved FROM email per tenant
    tenantEmailCopyTo: 3600  # 1 hour - resolved COPY-TO email per tenant
  maxSize: 1000

# AWS Configuration
aws:
  s3:
    access-key: ${AWS_ACCESS_KEY_ID:}
    secret-key: ${AWS_SECRET_ACCESS_KEY:}
    region: ${AWS_REGION:us-east-1}
    bucket-name: ${AWS_S3_BUCKET_NAME:}
  ses:
    rate-limit-per-second: ${AWS_SES_RATE_LIMIT_PER_SECOND:200}
    from-email: ${AWS_SES_FROM_EMAIL:noreply@example.com}

# Stripe Configuration (tenant-specific, loaded from database)
stripe:
  default-api-key: ${STRIPE_DEFAULT_API_KEY:}

# Backend API Configuration
backend:
  api:
    base-url: ${BACKEND_API_BASE_URL:${NEXT_PUBLIC_API_BASE_URL:http://localhost:8080}}
    jwt:
      username: ${API_JWT_USER:${NEXT_PUBLIC_API_JWT_USER:}}
      password: ${API_JWT_PASS:${NEXT_PUBLIC_API_JWT_PASS:}}
      cache-ttl-seconds: ${BACKEND_JWT_CACHE_TTL_SECONDS:3600}

# Batch Job Configuration
batch:
  subscription-renewal:
    enabled: ${SUBSCRIPTION_RENEWAL_ENABLED:true}
    schedule-cron: ${SUBSCRIPTION_RENEWAL_CRON:0 0 */6 * * *}  # Every 6 hours
    batch-size: ${SUBSCRIPTION_RENEWAL_BATCH_SIZE:100}
    max-subscriptions: ${SUBSCRIPTION_RENEWAL_MAX_SUBSCRIPTIONS:10000}
    days-before-renewal: ${SUBSCRIPTION_RENEWAL_DAYS_BEFORE:7}

# Subscription Renewal Fallback Configuration
subscription:
  renewal:
    use-database-fallback: ${USE_DATABASE_FALLBACK:false}  # Set to true for dev/testing, false for production

  email:
    enabled: ${EMAIL_BATCH_ENABLED:true}
    schedule-cron: ${EMAIL_BATCH_CRON:0 0 2 * * *}  # Daily at 2 AM
    batch-size: ${EMAIL_BATCH_SIZE:50}
    max-emails: ${EMAIL_BATCH_MAX_EMAILS:10000}

  stripe-fees-tax:
    enabled: ${STRIPE_FEES_TAX_ENABLED:true}
    schedule-cron: ${STRIPE_FEES_TAX_CRON:0 0 2 * * *}  # Daily at 2 AM
    batch-size: ${STRIPE_FEES_TAX_BATCH_SIZE:100}
    rate-limit-delay-ms: ${STRIPE_FEES_TAX_RATE_LIMIT_DELAY_MS:100}

  manual-payment-summary:
    enabled: ${MANUAL_PAYMENT_SUMMARY_ENABLED:true}
    schedule-cron: ${MANUAL_PAYMENT_SUMMARY_CRON:0 0 2 * * *}  # Daily at 2 AM

# Logging
logging:
  level:
    root: INFO
    com.eventmanager.batch: DEBUG
    org.springframework.batch: INFO
    org.springframework.jdbc: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

