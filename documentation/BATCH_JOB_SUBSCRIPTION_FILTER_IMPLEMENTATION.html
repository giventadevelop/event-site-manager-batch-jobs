<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Job: Subscription Filter Support for Testing - Implementation Guide</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans Pro', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #2D2A26;
            background-color: #F5F1E8;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: #FFFFFF;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(139, 125, 107, 0.1);
        }

        h1 {
            font-family: 'Crimson Text', serif;
            font-size: 2.5em;
            color: #8B7D6B;
            margin-bottom: 10px;
            border-bottom: 3px solid #8B7D6B;
            padding-bottom: 10px;
        }

        h2 {
            font-family: 'Crimson Text', serif;
            font-size: 2em;
            color: #6B4E3D;
            margin-top: 40px;
            margin-bottom: 20px;
            border-bottom: 2px solid #A0926B;
            padding-bottom: 8px;
        }

        h3 {
            font-family: 'Crimson Text', serif;
            font-size: 1.5em;
            color: #8B7D6B;
            margin-top: 30px;
            margin-bottom: 15px;
        }

        h4 {
            font-family: 'Crimson Text', serif;
            font-size: 1.25em;
            color: #6B4E3D;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        p {
            margin-bottom: 15px;
            text-align: justify;
        }

        ul, ol {
            margin-left: 30px;
            margin-bottom: 20px;
        }

        li {
            margin-bottom: 8px;
        }

        code {
            background-color: #EDE7D3;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
            color: #6B4E3D;
        }

        pre {
            background-color: #2D2A26;
            color: #F5F1E8;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 20px 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
            line-height: 1.5;
        }

        pre code {
            background-color: transparent;
            color: #F5F1E8;
            padding: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: #FFFFFF;
        }

        th, td {
            border: 1px solid #A0926B;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #8B7D6B;
            color: #FFFFFF;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background-color: #F5F1E8;
        }

        .info-box {
            background-color: #EDE7D3;
            border-left: 4px solid #8B7D6B;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .warning-box {
            background-color: #FFF4E6;
            border-left: 4px solid #A67C52;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .success-box {
            background-color: #E8F5E9;
            border-left: 4px solid #4A6741;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .critical-box {
            background-color: #FFEBEE;
            border-left: 4px solid #8B4A42;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            font-weight: 600;
        }

        .code-block-title {
            background-color: #6B4E3D;
            color: #FFFFFF;
            padding: 8px 15px;
            border-radius: 8px 8px 0 0;
            font-size: 0.85em;
            font-weight: 600;
            margin-top: 20px;
            margin-bottom: 0;
        }

        .code-block-title + pre {
            margin-top: 0;
            border-radius: 0 0 8px 8px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge-primary {
            background-color: #8B7D6B;
            color: #FFFFFF;
        }

        .badge-success {
            background-color: #4A6741;
            color: #FFFFFF;
        }

        .badge-warning {
            background-color: #A67C52;
            color: #FFFFFF;
        }

        .footer {
            margin-top: 60px;
            padding-top: 20px;
            border-top: 2px solid #A0926B;
            text-align: center;
            color: #8B7D6B;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Batch Job: Subscription Filter Support for Testing <span class="badge badge-primary">v1.0</span></h1>

        <div class="critical-box">
            <p><strong>⚠️ CRITICAL: This is a TESTING/DEVELOPMENT feature only!</strong></p>
            <ul style="margin-top: 10px;">
                <li><strong>SCHEDULED JOB UNCHANGED</strong> - The batch job that runs every 6 hours remains completely unaffected</li>
                <li><strong>7-DAY FILTER PRESERVED</strong> - Scheduled jobs still only process subscriptions expiring within 7 days</li>
                <li><strong>TESTING ONLY</strong> - When <code>stripeSubscriptionId</code> is provided, bypasses 7-day filter for that specific subscription</li>
                <li><strong>CONDITIONAL LOGIC</strong> - Query changes only when testing specific subscription IDs</li>
            </ul>
        </div>

        <div class="info-box">
            <p><strong>Project Location:</strong> <code>E:\project_workspace\event-site-manager-batch-jobs</code></p>
            <p><strong>Purpose:</strong> Support filtering by <code>stripeSubscriptionId</code> for testing specific subscriptions, while preserving existing scheduled job behavior</p>
        </div>

        <h2>1. Overview</h2>

        <h3>1.1 Current Situation</h3>
        <p>The batch job query only processes subscriptions expiring within 7 days. When testing specific subscriptions that are more than 7 days away, they are not found and not processed.</p>

        <div class="warning-box">
            <p><strong>Current Batch Job Log:</strong></p>
            <pre><code>Received request to trigger subscription renewal job for tenant: tenant_demo_002,
stripeSubscriptionId: null

Loaded 0 subscriptions for renewal processing</code></pre>
        </div>

        <h3>1.2 What We're Adding</h3>
        <ul>
            <li><strong>Conditional query logic</strong> - If <code>stripeSubscriptionId</code> is provided, filter by it and bypass 7-day restriction</li>
            <li><strong>Preserve scheduled job behavior</strong> - If <code>stripeSubscriptionId</code> is NOT provided, use existing 7-day filter</li>
            <li><strong>Dynamic SQL building</strong> - Build query based on job parameters</li>
        </ul>

        <h3>1.3 What Remains Unchanged</h3>
        <div class="success-box">
            <p><strong>✅ The scheduled batch job (runs every 6 hours) is completely unaffected:</strong></p>
            <ul>
                <li>Scheduled jobs don't provide <code>stripeSubscriptionId</code> parameter</li>
                <li>Query uses existing 7-day filter (unchanged behavior)</li>
                <li>Still processes subscriptions expiring within 7 days</li>
                <li>No performance impact on scheduled runs</li>
            </ul>
        </div>

        <h2>2. Implementation</h2>

        <h3>2.1 File Location</h3>
        <p><strong>File:</strong> <code>src/main/java/com/yourcompany/batch/SubscriptionRenewalBatchJobConfig.java</code> (or similar)</p>
        <p><strong>Method:</strong> <code>subscriptionReader()</code> bean method</p>

        <h3>2.2 Current Code (Before Fix)</h3>
        <div class="code-block-title">Java - Current Implementation</div>
        <pre><code>@Bean
@StepScope
public ItemReader&lt;MembershipSubscription&gt; subscriptionReader() {
    return new JdbcCursorItemReaderBuilder&lt;MembershipSubscription&gt;()
        .dataSource(dataSource)
        .sql("SELECT * FROM membership_subscription " +
             "WHERE subscription_status IN ('ACTIVE', 'TRIAL') " +
             "AND current_period_end &lt;= CURRENT_DATE + INTERVAL '7 days' " +  // ❌ Always applies 7-day filter
             "AND cancel_at_period_end = false " +
             "ORDER BY current_period_end ASC")
        .rowMapper(new BeanPropertyRowMapper&lt;&gt;(MembershipSubscription.class))
        .build();
}</code></pre>

        <h3>2.3 Updated Code (After Fix)</h3>
        <div class="code-block-title">Java - Updated Implementation</div>
        <pre><code>@Bean
@StepScope
public ItemReader&lt;MembershipSubscription&gt; subscriptionReader(
        @Value("#{jobParameters['stripeSubscriptionId']}") String stripeSubscriptionId,
        @Value("#{jobParameters['tenantId']}") String tenantId) {

    JdbcCursorItemReaderBuilder&lt;MembershipSubscription&gt; builder =
        new JdbcCursorItemReaderBuilder&lt;MembershipSubscription&gt;()
            .dataSource(dataSource)
            .rowMapper(new BeanPropertyRowMapper&lt;&gt;(MembershipSubscription.class));

    // Build dynamic SQL based on job parameters
    StringBuilder sql = new StringBuilder(
        "SELECT * FROM membership_subscription WHERE 1=1 "
    );

    // Add tenant filter (always applied)
    if (tenantId != null && !tenantId.isEmpty()) {
        sql.append("AND tenant_id = :tenantId ");
    }

    // ✅ KEY CHANGE: Conditional logic for subscription ID filter
    if (stripeSubscriptionId != null && !stripeSubscriptionId.isEmpty()) {
        // Testing mode: Filter by specific subscription ID (bypasses 7-day restriction)
        sql.append("AND stripe_subscription_id = :stripeSubscriptionId ");
    } else {
        // Scheduled job mode: Apply 7-day filter (existing behavior)
        sql.append("AND current_period_end &lt;= CURRENT_DATE + INTERVAL '7 days' ");
    }

    // Common filters (always applied)
    sql.append("AND subscription_status IN ('ACTIVE', 'TRIAL') ");
    sql.append("AND cancel_at_period_end = false ");
    sql.append("ORDER BY current_period_end ASC");

    builder.sql(sql.toString());

    // Set parameters
    Map&lt;String, Object&gt; parameters = new HashMap&lt;&gt;();
    if (tenantId != null && !tenantId.isEmpty()) {
        parameters.put("tenantId", tenantId);
    }
    if (stripeSubscriptionId != null && !stripeSubscriptionId.isEmpty()) {
        parameters.put("stripeSubscriptionId", stripeSubscriptionId);
    }
    builder.parameterValues(parameters);

    return builder.build();
}</code></pre>

        <h3>2.4 Key Changes</h3>
        <ol>
            <li><strong>Add <code>@StepScope</code> annotation</strong> - Required to access job parameters</li>
            <li><strong>Inject job parameters</strong> - Use <code>@Value("#{jobParameters[...]}")</code> to get parameters</li>
            <li><strong>Conditional SQL building</strong> - Build query dynamically based on whether <code>stripeSubscriptionId</code> is provided</li>
            <li><strong>Preserve 7-day filter</strong> - Only bypass when testing specific subscription</li>
        </ol>

        <h2>3. Query Behavior Comparison</h2>

        <h3>3.1 Scheduled Job (Every 6 Hours) - Unchanged</h3>
        <div class="success-box">
            <p><strong>Job Parameters:</strong> <code>tenantId</code> only (no <code>stripeSubscriptionId</code>)</p>
            <p><strong>Generated SQL:</strong></p>
            <pre><code>SELECT * FROM membership_subscription
WHERE 1=1
AND tenant_id = :tenantId
AND current_period_end &lt;= CURRENT_DATE + INTERVAL '7 days'  -- ✅ 7-day filter applied
AND subscription_status IN ('ACTIVE', 'TRIAL')
AND cancel_at_period_end = false
ORDER BY current_period_end ASC</code></pre>
            <p><strong>Result:</strong> ✅ Same behavior as before - processes subscriptions expiring within 7 days</p>
        </div>

        <h3>3.2 Manual Trigger for Testing - New Behavior</h3>
        <div class="info-box">
            <p><strong>Job Parameters:</strong> <code>tenantId</code> and <code>stripeSubscriptionId</code></p>
            <p><strong>Generated SQL:</strong></p>
            <pre><code>SELECT * FROM membership_subscription
WHERE 1=1
AND tenant_id = :tenantId
AND stripe_subscription_id = :stripeSubscriptionId  -- ✅ Specific subscription filter
-- ✅ NO 7-day filter (bypassed for testing)
AND subscription_status IN ('ACTIVE', 'TRIAL')
AND cancel_at_period_end = false
ORDER BY current_period_end ASC</code></pre>
            <p><strong>Result:</strong> ✅ Finds specific subscription regardless of expiration date</p>
        </div>

        <h2>4. Impact Assessment</h2>

        <table>
            <thead>
                <tr>
                    <th>Scenario</th>
                    <th>stripeSubscriptionId Provided?</th>
                    <th>Query Behavior</th>
                    <th>Impact</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Scheduled Job (every 6 hours)</td>
                    <td>❌ No</td>
                    <td>7-day filter applied</td>
                    <td>✅ No change - existing behavior</td>
                </tr>
                <tr>
                    <td>Manual Trigger (testing)</td>
                    <td>✅ Yes</td>
                    <td>Subscription ID filter, no 7-day restriction</td>
                    <td>✅ New feature - allows testing</td>
                </tr>
                <tr>
                    <td>Manual Trigger (all subscriptions)</td>
                    <td>❌ No</td>
                    <td>7-day filter applied</td>
                    <td>✅ Same as scheduled job</td>
                </tr>
            </tbody>
        </table>

        <h2>5. Testing Scenarios</h2>

        <h3>5.1 Scenario 1: Scheduled Job (Unchanged)</h3>
        <div class="success-box">
            <p><strong>Trigger:</strong> Automated cron job (every 6 hours)</p>
            <p><strong>Parameters:</strong> <code>tenantId</code> only</p>
            <p><strong>Query:</strong> Uses 7-day filter</p>
            <p><strong>Result:</strong> Processes subscriptions expiring within 7 days</p>
            <p><strong>Status:</strong> ✅ Unchanged - works exactly as before</p>
        </div>

        <h3>5.2 Scenario 2: Test Specific Subscription</h3>
        <div class="info-box">
            <p><strong>Trigger:</strong> Manual API call with <code>stripeSubscriptionId</code></p>
            <p><strong>Parameters:</strong> <code>tenantId</code> and <code>stripeSubscriptionId</code></p>
            <p><strong>Query:</strong> Filters by subscription ID, bypasses 7-day restriction</p>
            <p><strong>Result:</strong> Finds and processes specific subscription</p>
            <p><strong>Status:</strong> ✅ New feature - enables testing</p>
        </div>

        <h3>5.3 Scenario 3: Test All Subscriptions (Manual)</h3>
        <div class="success-box">
            <p><strong>Trigger:</strong> Manual API call without <code>stripeSubscriptionId</code></p>
            <p><strong>Parameters:</strong> <code>tenantId</code> only</p>
            <p><strong>Query:</strong> Uses 7-day filter</p>
            <p><strong>Result:</strong> Processes subscriptions expiring within 7 days</p>
            <p><strong>Status:</strong> ✅ Same as scheduled job</p>
        </div>

        <h2>6. Verification Steps</h2>

        <ol>
            <li><strong>Deploy the batch job changes</strong></li>
            <li><strong>Trigger batch job with subscription ID:</strong>
                <pre><code>node scripts/test-subscription-renewal/trigger-batch-job.js \
  --tenant-id=tenant_demo_002 \
  --subscription-id=sub_1SeifsK5BrggeAHMBvg2XE93</code></pre>
            </li>
            <li><strong>Check batch job logs</strong> - Should see:
                <pre><code>Received request to trigger subscription renewal job for tenant: tenant_demo_002,
stripeSubscriptionId: sub_1SeifsK5BrggeAHMBvg2XE93

Loaded 1 subscriptions for renewal processing  -- ✅ Should find the subscription</code></pre>
            </li>
            <li><strong>Verify database updated</strong> - Run verification script:
                <pre><code>node scripts/test-subscription-renewal/verify-database.js \
  --subscription-id=sub_1SeifsK5BrggeAHMBvg2XE93 \
  --tenant-id=tenant_demo_002</code></pre>
            </li>
            <li><strong>Verify scheduled job still works</strong> - Wait for next scheduled run and verify it processes subscriptions with 7-day filter</li>
        </ol>

        <h2>7. Important Notes</h2>

        <div class="warning-box">
            <p><strong>⚠️ Performance Considerations:</strong></p>
            <ul>
                <li>When <code>stripeSubscriptionId</code> is provided, the query uses an index on <code>stripe_subscription_id</code> (fast lookup)</li>
                <li>When <code>stripeSubscriptionId</code> is NOT provided, the query uses the existing index on <code>current_period_end</code> (unchanged performance)</li>
                <li>No performance impact on scheduled jobs</li>
            </ul>
        </div>

        <div class="info-box">
            <p><strong>✅ Backward Compatibility:</strong></p>
            <ul>
                <li>Existing scheduled jobs continue to work unchanged</li>
                <li>Manual triggers without <code>stripeSubscriptionId</code> behave the same as scheduled jobs</li>
                <li>Only manual triggers WITH <code>stripeSubscriptionId</code> get new behavior</li>
            </ul>
        </div>

        <h2>8. Summary</h2>

        <div class="info-box">
            <p><strong>What we're doing:</strong></p>
            <ul>
                <li>✅ Adding conditional query logic based on job parameters</li>
                <li>✅ Supporting <code>stripeSubscriptionId</code> filter for testing</li>
                <li>✅ Preserving 7-day filter for scheduled jobs</li>
                <li>✅ Maintaining backward compatibility</li>
            </ul>
        </div>

        <div class="warning-box">
            <p><strong>What we're NOT doing:</strong></p>
            <ul>
                <li>❌ Not changing scheduled job behavior</li>
                <li>❌ Not removing the 7-day filter</li>
                <li>❌ Not affecting production batch job runs</li>
                <li>❌ Not creating new batch job types</li>
            </ul>
        </div>

        <div class="success-box">
            <p><strong>Key Design Principle:</strong></p>
            <p><strong>"When <code>stripeSubscriptionId</code> is provided → Testing mode (bypass 7-day filter)</strong></p>
            <p><strong>When <code>stripeSubscriptionId</code> is NOT provided → Production mode (use 7-day filter)"</strong></p>
        </div>

        <div class="footer">
            <p><strong>Batch Job: Subscription Filter Support for Testing - Implementation Guide</strong></p>
            <p>Version 1.0 | Date: 2025-12-16</p>
            <p><strong>Related Documentation:</strong> <code>BACKEND_SUBSCRIPTION_FILTER_IMPLEMENTATION.html</code> (Backend Project)</p>
        </div>
    </div>
</body>
</html>

