<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backend API Integration Guide: Stripe Fees and Tax Batch Job</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
            border-left: 4px solid #3498db;
            padding-left: 15px;
        }
        h3 {
            color: #555;
            margin-top: 25px;
        }
        .info-box {
            background-color: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .warning-box {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .success-box {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .code-block {
            background-color: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 15px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #3498db;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .field-name {
            font-family: 'Courier New', monospace;
            background-color: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
        }
        ul, ol {
            margin: 15px 0;
            padding-left: 30px;
        }
        li {
            margin: 8px 0;
        }
        .endpoint-box {
            background-color: #e8f4f8;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .method {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: bold;
            color: white;
            background-color: #28a745;
            margin-right: 10px;
        }
        .endpoint-path {
            font-family: 'Courier New', monospace;
            font-size: 16px;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Backend API Integration Guide: Stripe Fees and Tax Batch Job</h1>
        <p><strong>Document Date:</strong> January 11, 2026</p>
        <p><strong>Purpose:</strong> Guide for integrating the Stripe Fees and Tax Update Batch Job API from the backend Spring Boot application.</p>
        <p><strong>Backend Project:</strong> <code>E:\project_workspace\malayalees-us-site-boot</code></p>
        <p><strong>Batch Job Project:</strong> <code>E:\project_workspace\event-site-manager-batch-jobs</code></p>

        <div class="info-box">
            <h2>Executive Summary</h2>
            <p>This document provides a comprehensive guide for integrating the Stripe Fees and Tax Update Batch Job API from your backend Spring Boot application. The batch job service runs independently and provides REST API endpoints that can be called from the backend to trigger batch processing of Stripe fee and tax data retrieval and updates.</p>
        </div>

        <h2>1. Overview</h2>
        <p>The Stripe Fees and Tax Update Batch Job is a separate Spring Boot service that:</p>
        <ul>
            <li>Retrieves missing Stripe fee and tax data from Stripe's API</li>
            <li>Updates transaction records in the database via backend API</li>
            <li>Supports multi-tenant processing</li>
            <li>Provides both scheduled and on-demand execution</li>
            <li>Processes transactions in batches to handle large datasets efficiently</li>
        </ul>

        <div class="info-box">
            <h3>Service Location</h3>
            <ul>
                <li><strong>Batch Job Service URL:</strong> Configurable via environment variable (default: <code>http://localhost:8081/batch-jobs</code>)</li>
                <li><strong>Context Path:</strong> <code>/batch-jobs</code></li>
                <li><strong>Default Port:</strong> <code>8081</code> (to avoid conflict with backend on 8080)</li>
            </ul>
        </div>

        <h2>2. API Endpoint Details</h2>
        <div class="endpoint-box">
            <div>
                <span class="method">POST</span>
                <span class="endpoint-path">/api/batch-jobs/stripe-fees-tax-update</span>
            </div>
            <p><strong>Description:</strong> Triggers the Stripe fees and tax update batch job.</p>
            <p><strong>Response:</strong> Returns immediately with job ID and status (HTTP 202 Accepted)</p>
            <p><strong>Processing:</strong> Runs asynchronously in the background</p>
        </div>

        <h3>2.1 Request Headers</h3>
        <table>
            <thead>
                <tr>
                    <th>Header</th>
                    <th>Value</th>
                    <th>Required</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Content-Type</td>
                    <td>application/json</td>
                    <td>Yes</td>
                </tr>
            </tbody>
        </table>

        <h3>2.2 Request Body</h3>
        <p>All fields in the request body are <strong>optional</strong>. An empty JSON object <code>{}</code> will process all tenants with no date filters.</p>
        <table>
            <thead>
                <tr>
                    <th>Field</th>
                    <th>Type</th>
                    <th>Description</th>
                    <th>Required</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><span class="field-name">tenantId</span></td>
                    <td>String</td>
                    <td>Filter by specific tenant ID. If not provided, processes all tenants sequentially.</td>
                    <td>No</td>
                </tr>
                <tr>
                    <td><span class="field-name">startDate</span></td>
                    <td>String (ISO 8601)</td>
                    <td>Process transactions created on or after this date. Format: <code>yyyy-MM-dd'T'HH:mm:ss.SSSXXX</code></td>
                    <td>No</td>
                </tr>
                <tr>
                    <td><span class="field-name">endDate</span></td>
                    <td>String (ISO 8601)</td>
                    <td>Process transactions created on or before this date. Format: <code>yyyy-MM-dd'T'HH:mm:ss.SSSXXX</code></td>
                    <td>No</td>
                </tr>
                <tr>
                    <td><span class="field-name">forceUpdate</span></td>
                    <td>Boolean</td>
                    <td>If <code>true</code>, update even if <code>stripe_fee_amount</code> is already populated. Default: <code>false</code></td>
                    <td>No</td>
                </tr>
            </tbody>
        </table>

        <h3>2.3 Response Format</h3>
        <p><strong>HTTP Status:</strong> <code>202 Accepted</code> (when job starts successfully)</p>
        <div class="code-block">
{
  "jobId": "stripe-fees-update-20250111-140530-tenant_demo_002",
  "status": "STARTED",
  "tenantId": "tenant_demo_002",
  "startDate": "2025-01-01T00:00:00.000Z",
  "endDate": "2025-01-31T23:59:59.999Z",
  "forceUpdate": false,
  "estimatedRecords": 150,
  "estimatedCompletionTime": "2025-01-11T14:15:30.000Z",
  "message": "Batch job started successfully"
}
        </div>

        <table>
            <thead>
                <tr>
                    <th>Field</th>
                    <th>Type</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><span class="field-name">jobId</span></td>
                    <td>String</td>
                    <td>Unique job identifier for tracking</td>
                </tr>
                <tr>
                    <td><span class="field-name">status</span></td>
                    <td>String</td>
                    <td>Job status: <code>STARTED</code>, <code>IN_PROGRESS</code>, <code>COMPLETED</code>, <code>FAILED</code></td>
                </tr>
                <tr>
                    <td><span class="field-name">tenantId</span></td>
                    <td>String</td>
                    <td>Tenant ID being processed (null if processing all tenants)</td>
                </tr>
                <tr>
                    <td><span class="field-name">startDate</span></td>
                    <td>String</td>
                    <td>Start date filter (null if not provided)</td>
                </tr>
                <tr>
                    <td><span class="field-name">endDate</span></td>
                    <td>String</td>
                    <td>End date filter (null if not provided)</td>
                </tr>
                <tr>
                    <td><span class="field-name">forceUpdate</span></td>
                    <td>Boolean</td>
                    <td>Force update flag</td>
                </tr>
                <tr>
                    <td><span class="field-name">estimatedRecords</span></td>
                    <td>Long</td>
                    <td>Estimated number of transactions to process</td>
                </tr>
                <tr>
                    <td><span class="field-name">estimatedCompletionTime</span></td>
                    <td>String</td>
                    <td>Estimated completion time (ISO 8601 format)</td>
                </tr>
                <tr>
                    <td><span class="field-name">message</span></td>
                    <td>String</td>
                    <td>Human-readable status message</td>
                </tr>
            </tbody>
        </table>

        <h3>2.4 Error Responses</h3>
        <table>
            <thead>
                <tr>
                    <th>HTTP Status</th>
                    <th>Description</th>
                    <th>Response Body</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>400 Bad Request</td>
                    <td>Invalid request parameters (e.g., startDate after endDate)</td>
                    <td><code>{"status": "FAILED", "message": "startDate must be before or equal to endDate"}</code></td>
                </tr>
                <tr>
                    <td>500 Internal Server Error</td>
                    <td>Job failed to start</td>
                    <td><code>{"status": "FAILED", "message": "Failed to trigger job: [error details]"}</code></td>
                </tr>
            </tbody>
        </table>

        <h2>3. Implementation Steps</h2>

        <h3>3.1 Configuration</h3>
        <p>Add the following configuration to your <code>application.yml</code> or <code>application.properties</code>:</p>
        <div class="code-block">
# Batch Jobs Service Configuration
batch-jobs:
  service:
    url: ${BATCH_JOBS_SERVICE_URL:http://localhost:8081/batch-jobs}
    timeout: ${BATCH_JOBS_SERVICE_TIMEOUT:30000}
    enabled: ${BATCH_JOBS_SERVICE_ENABLED:true}
        </div>

        <p><strong>Environment Variables:</strong></p>
        <ul>
            <li><code>BATCH_JOBS_SERVICE_URL</code>: Base URL of the batch jobs service (default: <code>http://localhost:8081/batch-jobs</code>)</li>
            <li><code>BATCH_JOBS_SERVICE_TIMEOUT</code>: HTTP request timeout in milliseconds (default: 30000)</li>
            <li><code>BATCH_JOBS_SERVICE_ENABLED</code>: Enable/disable batch job service integration (default: true)</li>
        </ul>

        <h3>3.2 DTOs (Data Transfer Objects)</h3>
        <p>Create the following DTOs in your backend project:</p>

        <h4>3.2.1 StripeFeesTaxUpdateRequest.java</h4>
        <div class="code-block">
package com.yourpackage.dto;

import com.fasterxml.jackson.annotation.JsonFormat;
import lombok.Data;
import java.time.ZonedDateTime;

@Data
public class StripeFeesTaxUpdateRequest {
    /**
     * Optional tenant ID to filter by. If not provided, processes all tenants.
     */
    private String tenantId;

    /**
     * Optional start date (ISO 8601 format). Process transactions created on or after this date.
     */
    @JsonFormat(shape = JsonFormat.Shape.STRING, pattern = "yyyy-MM-dd'T'HH:mm:ss.SSSXXX")
    private ZonedDateTime startDate;

    /**
     * Optional end date (ISO 8601 format). Process transactions created on or before this date.
     */
    @JsonFormat(shape = JsonFormat.Shape.STRING, pattern = "yyyy-MM-dd'T'HH:mm:ss.SSSXXX")
    private ZonedDateTime endDate;

    /**
     * If true, update even if stripe_fee_amount is already populated. Default: false.
     */
    private Boolean forceUpdate = false;
}
        </div>

        <h4>3.2.2 StripeFeesTaxUpdateResponse.java</h4>
        <div class="code-block">
package com.yourpackage.dto;

import com.fasterxml.jackson.annotation.JsonFormat;
import lombok.Builder;
import lombok.Data;
import java.time.ZonedDateTime;

@Data
@Builder
public class StripeFeesTaxUpdateResponse {
    private String jobId;
    private String status;
    private String tenantId;

    @JsonFormat(shape = JsonFormat.Shape.STRING, pattern = "yyyy-MM-dd'T'HH:mm:ss.SSSXXX")
    private ZonedDateTime startDate;

    @JsonFormat(shape = JsonFormat.Shape.STRING, pattern = "yyyy-MM-dd'T'HH:mm:ss.SSSXXX")
    private ZonedDateTime endDate;

    private Boolean forceUpdate;
    private Long estimatedRecords;

    @JsonFormat(shape = JsonFormat.Shape.STRING, pattern = "yyyy-MM-dd'T'HH:mm:ss.SSSXXX")
    private ZonedDateTime estimatedCompletionTime;

    private String message;
}
        </div>

        <h3>3.3 Service Interface</h3>
        <p>Create a service interface for batch job operations:</p>
        <div class="code-block">
package com.yourpackage.service;

import com.yourpackage.dto.StripeFeesTaxUpdateRequest;
import com.yourpackage.dto.StripeFeesTaxUpdateResponse;

public interface BatchJobService {
    /**
     * Trigger Stripe fees and tax update batch job.
     *
     * @param request Request parameters (all optional)
     * @return Response with job ID and status
     */
    StripeFeesTaxUpdateResponse triggerStripeFeesTaxUpdate(StripeFeesTaxUpdateRequest request);

    /**
     * Trigger Stripe fees and tax update for a specific tenant.
     *
     * @param tenantId Tenant ID
     * @return Response with job ID and status
     */
    StripeFeesTaxUpdateResponse triggerStripeFeesTaxUpdate(String tenantId);

    /**
     * Trigger Stripe fees and tax update for all tenants.
     *
     * @return Response with job ID and status
     */
    StripeFeesTaxUpdateResponse triggerStripeFeesTaxUpdate();
}
        </div>

        <h3>3.4 Service Implementation</h3>
        <p>Implement the service using Spring's <code>RestTemplate</code> or <code>WebClient</code>:</p>
        <div class="code-block">
package com.yourpackage.service.impl;

import com.yourpackage.dto.StripeFeesTaxUpdateRequest;
import com.yourpackage.dto.StripeFeesTaxUpdateResponse;
import com.yourpackage.service.BatchJobService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.web.client.HttpClientErrorException;
import org.springframework.web.client.HttpServerErrorException;
import org.springframework.web.client.RestTemplate;

@Service
@RequiredArgsConstructor
@Slf4j
public class BatchJobServiceImpl implements BatchJobService {

    private final RestTemplate restTemplate;

    @Value("${batch-jobs.service.url:http://localhost:8081/batch-jobs}")
    private String batchJobsServiceUrl;

    @Value("${batch-jobs.service.timeout:30000}")
    private int timeout;

    @Value("${batch-jobs.service.enabled:true}")
    private boolean enabled;

    @Override
    public StripeFeesTaxUpdateResponse triggerStripeFeesTaxUpdate(StripeFeesTaxUpdateRequest request) {
        if (!enabled) {
            log.warn("Batch jobs service is disabled");
            throw new IllegalStateException("Batch jobs service is disabled");
        }

        String url = batchJobsServiceUrl + "/api/batch-jobs/stripe-fees-tax-update";

        try {
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);

            HttpEntity<StripeFeesTaxUpdateRequest> requestEntity = new HttpEntity<>(request, headers);

            ResponseEntity<StripeFeesTaxUpdateResponse> response = restTemplate.exchange(
                url,
                HttpMethod.POST,
                requestEntity,
                StripeFeesTaxUpdateResponse.class
            );

            if (response.getStatusCode().is2xxSuccessful() && response.getBody() != null) {
                log.info("Successfully triggered Stripe fees and tax update job: {}",
                    response.getBody().getJobId());
                return response.getBody();
            } else {
                log.error("Unexpected response status: {}", response.getStatusCode());
                throw new RuntimeException("Failed to trigger batch job: " + response.getStatusCode());
            }
        } catch (HttpClientErrorException | HttpServerErrorException e) {
            log.error("HTTP error triggering batch job: {} - {}",
                e.getStatusCode(), e.getResponseBodyAsString());
            throw new RuntimeException("Failed to trigger batch job: " + e.getStatusCode(), e);
        } catch (Exception e) {
            log.error("Error triggering batch job: {}", e.getMessage(), e);
            throw new RuntimeException("Failed to trigger batch job", e);
        }
    }

    @Override
    public StripeFeesTaxUpdateResponse triggerStripeFeesTaxUpdate(String tenantId) {
        StripeFeesTaxUpdateRequest request = new StripeFeesTaxUpdateRequest();
        request.setTenantId(tenantId);
        return triggerStripeFeesTaxUpdate(request);
    }

    @Override
    public StripeFeesTaxUpdateResponse triggerStripeFeesTaxUpdate() {
        return triggerStripeFeesTaxUpdate(new StripeFeesTaxUpdateRequest());
    }
}
        </div>

        <h3>3.5 RestTemplate Configuration</h3>
        <p>Create a RestTemplate bean configuration:</p>
        <div class="code-block">
package com.yourpackage.config;

import org.springframework.boot.web.client.RestTemplateBuilder;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.client.RestTemplate;

import java.time.Duration;

@Configuration
public class BatchJobConfig {

    @Bean
    public RestTemplate restTemplate(RestTemplateBuilder builder) {
        return builder
            .setConnectTimeout(Duration.ofSeconds(10))
            .setReadTimeout(Duration.ofSeconds(30))
            .build();
    }
}
        </div>

        <h3>3.6 Controller Example</h3>
        <p>Example controller endpoint to trigger the batch job:</p>
        <div class="code-block">
package com.yourpackage.controller;

import com.yourpackage.dto.StripeFeesTaxUpdateRequest;
import com.yourpackage.dto.StripeFeesTaxUpdateResponse;
import com.yourpackage.service.BatchJobService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/admin/batch-jobs")
@RequiredArgsConstructor
@Slf4j
public class BatchJobController {

    private final BatchJobService batchJobService;

    /**
     * Trigger Stripe fees and tax update batch job.
     */
    @PostMapping("/stripe-fees-tax-update")
    public ResponseEntity<StripeFeesTaxUpdateResponse> triggerStripeFeesTaxUpdate(
        @RequestBody(required = false) StripeFeesTaxUpdateRequest request
    ) {
        try {
            if (request == null) {
                request = new StripeFeesTaxUpdateRequest();
            }

            StripeFeesTaxUpdateResponse response = batchJobService.triggerStripeFeesTaxUpdate(request);
            return ResponseEntity.status(HttpStatus.ACCEPTED).body(response);
        } catch (Exception e) {
            log.error("Failed to trigger Stripe fees and tax update job: {}", e.getMessage(), e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();
        }
    }
}
        </div>

        <h2>4. Usage Examples</h2>

        <h3>4.1 Process All Tenants (No Filters)</h3>
        <div class="code-block">
// Request
POST /api/admin/batch-jobs/stripe-fees-tax-update
Content-Type: application/json

{}

// Response
HTTP 202 Accepted
{
  "jobId": "stripe-fees-update-20250111-140530",
  "status": "STARTED",
  "tenantId": null,
  "startDate": null,
  "endDate": null,
  "forceUpdate": false,
  "estimatedRecords": 1250,
  "estimatedCompletionTime": "2025-01-11T14:50:30.000Z",
  "message": "Batch job started successfully"
}
        </div>

        <h3>4.2 Process Specific Tenant</h3>
        <div class="code-block">
// Request
POST /api/admin/batch-jobs/stripe-fees-tax-update
Content-Type: application/json

{
  "tenantId": "tenant_demo_002"
}

// Response
HTTP 202 Accepted
{
  "jobId": "stripe-fees-update-20250111-140530-tenant_demo_002",
  "status": "STARTED",
  "tenantId": "tenant_demo_002",
  "startDate": null,
  "endDate": null,
  "forceUpdate": false,
  "estimatedRecords": 150,
  "estimatedCompletionTime": "2025-01-11T14:15:30.000Z",
  "message": "Batch job started successfully"
}
        </div>

        <h3>4.3 Process Specific Tenant with Date Range</h3>
        <div class="code-block">
// Request
POST /api/admin/batch-jobs/stripe-fees-tax-update
Content-Type: application/json

{
  "tenantId": "tenant_demo_002",
  "startDate": "2025-01-01T00:00:00.000Z",
  "endDate": "2025-01-31T23:59:59.999Z"
}

// Response
HTTP 202 Accepted
{
  "jobId": "stripe-fees-update-20250111-140530-tenant_demo_002",
  "status": "STARTED",
  "tenantId": "tenant_demo_002",
  "startDate": "2025-01-01T00:00:00.000Z",
  "endDate": "2025-01-31T23:59:59.999Z",
  "forceUpdate": false,
  "estimatedRecords": 85,
  "estimatedCompletionTime": "2025-01-11T14:12:10.000Z",
  "message": "Batch job started successfully"
}
        </div>

        <h3>4.4 Force Update (Reprocess Already Populated Transactions)</h3>
        <div class="code-block">
// Request
POST /api/admin/batch-jobs/stripe-fees-tax-update
Content-Type: application/json

{
  "tenantId": "tenant_demo_002",
  "forceUpdate": true
}

// Response
HTTP 202 Accepted
{
  "jobId": "stripe-fees-update-20250111-140530-tenant_demo_002",
  "status": "STARTED",
  "tenantId": "tenant_demo_002",
  "startDate": null,
  "endDate": null,
  "forceUpdate": true,
  "estimatedRecords": 250,
  "estimatedCompletionTime": "2025-01-11T14:18:50.000Z",
  "message": "Batch job started successfully"
}
        </div>

        <h3>4.5 Service Usage in Code</h3>
        <div class="code-block">
@Service
@RequiredArgsConstructor
public class YourService {

    private final BatchJobService batchJobService;

    public void triggerBatchJobForTenant(String tenantId) {
        try {
            StripeFeesTaxUpdateResponse response =
                batchJobService.triggerStripeFeesTaxUpdate(tenantId);

            log.info("Batch job triggered successfully. Job ID: {}, Estimated records: {}",
                response.getJobId(), response.getEstimatedRecords());
        } catch (Exception e) {
            log.error("Failed to trigger batch job: {}", e.getMessage(), e);
            // Handle error
        }
    }

    public void triggerBatchJobForDateRange(String tenantId,
                                            ZonedDateTime startDate,
                                            ZonedDateTime endDate) {
        StripeFeesTaxUpdateRequest request = new StripeFeesTaxUpdateRequest();
        request.setTenantId(tenantId);
        request.setStartDate(startDate);
        request.setEndDate(endDate);

        try {
            StripeFeesTaxUpdateResponse response =
                batchJobService.triggerStripeFeesTaxUpdate(request);

            log.info("Batch job triggered for date range. Job ID: {}", response.getJobId());
        } catch (Exception e) {
            log.error("Failed to trigger batch job: {}", e.getMessage(), e);
        }
    }
}
        </div>

        <h2>5. Error Handling</h2>
        <p>Implement proper error handling for various scenarios:</p>
        <table>
            <thead>
                <tr>
                    <th>Scenario</th>
                    <th>HTTP Status</th>
                    <th>Handling Strategy</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Service unavailable</td>
                    <td>Connection refused / Timeout</td>
                    <td>Log error, return meaningful error message to caller</td>
                </tr>
                <tr>
                    <td>Invalid request parameters</td>
                    <td>400 Bad Request</td>
                    <td>Validate parameters before calling service, return user-friendly error</td>
                </tr>
                <tr>
                    <td>Service error</td>
                    <td>500 Internal Server Error</td>
                    <td>Log error, alert administrators, return generic error to caller</td>
                </tr>
                <tr>
                    <td>Service disabled</td>
                    <td>N/A</td>
                    <td>Check enabled flag before making request</td>
                </tr>
            </tbody>
        </table>

        <h3>5.1 Enhanced Error Handling Example</h3>
        <div class="code-block">
@Override
public StripeFeesTaxUpdateResponse triggerStripeFeesTaxUpdate(StripeFeesTaxUpdateRequest request) {
    if (!enabled) {
        log.warn("Batch jobs service is disabled");
        throw new IllegalStateException("Batch jobs service is disabled");
    }

    // Validate request
    if (request.getStartDate() != null && request.getEndDate() != null) {
        if (request.getStartDate().isAfter(request.getEndDate())) {
            throw new IllegalArgumentException("startDate must be before or equal to endDate");
        }
    }

    String url = batchJobsServiceUrl + "/api/batch-jobs/stripe-fees-tax-update";

    try {
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);

        HttpEntity<StripeFeesTaxUpdateRequest> requestEntity = new HttpEntity<>(request, headers);

        ResponseEntity<StripeFeesTaxUpdateResponse> response = restTemplate.exchange(
            url,
            HttpMethod.POST,
            requestEntity,
            StripeFeesTaxUpdateResponse.class
        );

        if (response.getStatusCode().is2xxSuccessful() && response.getBody() != null) {
            log.info("Successfully triggered Stripe fees and tax update job: {}",
                response.getBody().getJobId());
            return response.getBody();
        } else {
            log.error("Unexpected response status: {}", response.getStatusCode());
            throw new RuntimeException("Failed to trigger batch job: " + response.getStatusCode());
        }
    } catch (HttpClientErrorException.BadRequest e) {
        log.warn("Bad request to batch job service: {}", e.getResponseBodyAsString());
        throw new IllegalArgumentException("Invalid request: " + e.getResponseBodyAsString(), e);
    } catch (HttpClientErrorException | HttpServerErrorException e) {
        log.error("HTTP error triggering batch job: {} - {}",
            e.getStatusCode(), e.getResponseBodyAsString());
        throw new RuntimeException("Failed to trigger batch job: " + e.getStatusCode(), e);
    } catch (org.springframework.web.client.ResourceAccessException e) {
        log.error("Connection error to batch job service: {}", e.getMessage());
        throw new RuntimeException("Batch job service is not available", e);
    } catch (Exception e) {
        log.error("Unexpected error triggering batch job: {}", e.getMessage(), e);
        throw new RuntimeException("Failed to trigger batch job", e);
    }
}
        </div>

        <h2>6. Best Practices</h2>
        <ul>
            <li><strong>Asynchronous Processing:</strong> The batch job runs asynchronously. Don't wait for completion. Use the returned <code>jobId</code> for tracking if needed.</li>
            <li><strong>Idempotency:</strong> The batch job is idempotent. Safe to call multiple times with the same parameters.</li>
            <li><strong>Rate Limiting:</strong> Be mindful of how frequently you trigger the job. Consider implementing rate limiting in your controller.</li>
            <li><strong>Monitoring:</strong> Monitor the batch job service health and logs to ensure it's running properly.</li>
            <li><strong>Error Handling:</strong> Always implement proper error handling and logging when calling the batch job service.</li>
            <li><strong>Configuration:</strong> Use environment variables for service URL and timeout configuration to support different environments.</li>
            <li><strong>Security:</strong> If the batch job service requires authentication, implement appropriate security measures.</li>
        </ul>

        <h2>7. Health Check</h2>
        <p>The batch job service provides a health check endpoint:</p>
        <div class="code-block">
GET /api/batch-jobs/health

Response: "Batch Jobs Service is running"
        </div>
        <p>You can use this endpoint to verify the service is available before making requests:</p>
        <div class="code-block">
@Value("${batch-jobs.service.url:http://localhost:8081/batch-jobs}")
private String batchJobsServiceUrl;

public boolean isBatchJobServiceAvailable() {
    try {
        ResponseEntity<String> response = restTemplate.getForEntity(
            batchJobsServiceUrl + "/api/batch-jobs/health",
            String.class
        );
        return response.getStatusCode().is2xxSuccessful();
    } catch (Exception e) {
        log.warn("Batch job service health check failed: {}", e.getMessage());
        return false;
    }
}
        </div>

        <h2>8. Testing</h2>
        <h3>8.1 Unit Tests</h3>
        <p>Create unit tests for your service implementation:</p>
        <div class="code-block">
@ExtendWith(MockitoExtension.class)
class BatchJobServiceImplTest {

    @Mock
    private RestTemplate restTemplate;

    @InjectMocks
    private BatchJobServiceImpl batchJobService;

    @Test
    void testTriggerStripeFeesTaxUpdate() {
        // Given
        StripeFeesTaxUpdateRequest request = new StripeFeesTaxUpdateRequest();
        request.setTenantId("tenant_demo_002");

        StripeFeesTaxUpdateResponse expectedResponse = StripeFeesTaxUpdateResponse.builder()
            .jobId("test-job-id")
            .status("STARTED")
            .build();

        ResponseEntity<StripeFeesTaxUpdateResponse> responseEntity =
            new ResponseEntity<>(expectedResponse, HttpStatus.ACCEPTED);

        when(restTemplate.exchange(anyString(), eq(HttpMethod.POST), any(),
            eq(StripeFeesTaxUpdateResponse.class)))
            .thenReturn(responseEntity);

        // When
        StripeFeesTaxUpdateResponse response = batchJobService.triggerStripeFeesTaxUpdate(request);

        // Then
        assertNotNull(response);
        assertEquals("test-job-id", response.getJobId());
        assertEquals("STARTED", response.getStatus());
    }
}
        </div>

        <h3>8.2 Integration Tests</h3>
        <p>Test against a running batch job service instance:</p>
        <div class="code-block">
@SpringBootTest
@ActiveProfiles("test")
class BatchJobServiceIntegrationTest {

    @Autowired
    private BatchJobService batchJobService;

    @Test
    void testTriggerStripeFeesTaxUpdateIntegration() {
        // Assuming batch job service is running on test environment
        StripeFeesTaxUpdateRequest request = new StripeFeesTaxUpdateRequest();
        request.setTenantId("test_tenant");

        StripeFeesTaxUpdateResponse response = batchJobService.triggerStripeFeesTaxUpdate(request);

        assertNotNull(response);
        assertNotNull(response.getJobId());
        assertEquals("STARTED", response.getStatus());
    }
}
        </div>

        <h2>9. Monitoring and Logging</h2>
        <p>Implement comprehensive logging for batch job triggers:</p>
        <ul>
            <li>Log when batch jobs are triggered with request parameters</li>
            <li>Log job IDs for tracking</li>
            <li>Log errors and exceptions</li>
            <li>Monitor batch job service availability</li>
            <li>Track job execution times and success rates</li>
        </ul>

        <h2>10. Deployment Considerations</h2>
        <div class="warning-box">
            <h3>Environment-Specific Configuration</h3>
            <p>Configure the batch job service URL for each environment:</p>
            <ul>
                <li><strong>Development:</strong> <code>http://localhost:8081/batch-jobs</code></li>
                <li><strong>Staging:</strong> <code>http://batch-jobs-staging:8081/batch-jobs</code></li>
                <li><strong>Production:</strong> <code>http://batch-jobs-production:8081/batch-jobs</code></li>
            </ul>
        </div>

        <h2>11. Troubleshooting</h2>
        <table>
            <thead>
                <tr>
                    <th>Issue</th>
                    <th>Possible Cause</th>
                    <th>Solution</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Connection refused</td>
                    <td>Batch job service is not running</td>
                    <td>Start the batch job service or check service URL configuration</td>
                </tr>
                <tr>
                    <td>Timeout</td>
                    <td>Service is slow or overloaded</td>
                    <td>Increase timeout configuration or check service health</td>
                </tr>
                <tr>
                    <td>400 Bad Request</td>
                    <td>Invalid request parameters</td>
                    <td>Validate request parameters before sending</td>
                </tr>
                <tr>
                    <td>500 Internal Server Error</td>
                    <td>Service error</td>
                    <td>Check batch job service logs for details</td>
                </tr>
            </tbody>
        </table>

        <h2>12. Additional Resources</h2>
        <ul>
            <li><strong>Batch Job Implementation:</strong> <code>documentation/event_ticketing/batch_job_stripe_fees_tax_implementation_prompt.html</code></li>
            <li><strong>Backend Project:</strong> <code>E:\project_workspace\malayalees-us-site-boot</code></li>
            <li><strong>Batch Job Project:</strong> <code>E:\project_workspace\event-site-manager-batch-jobs</code></li>
        </ul>

        <hr>
        <p><em>Document generated: January 11, 2026</em></p>
        <p><em>For questions or clarifications, refer to the batch job implementation documentation.</em></p>
    </div>
</body>
</html>
