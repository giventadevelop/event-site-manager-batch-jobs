<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Membership Subscription Feature - Backend PRD</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans Pro', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #2D2A26;
            background-color: #F5F1E8;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #FFFFFF;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(139, 125, 107, 0.1);
        }

        h1 {
            font-family: 'Crimson Text', serif;
            font-size: 2.5em;
            color: #8B7D6B;
            margin-bottom: 10px;
            border-bottom: 3px solid #8B7D6B;
            padding-bottom: 10px;
        }

        h2 {
            font-family: 'Crimson Text', serif;
            font-size: 2em;
            color: #6B4E3D;
            margin-top: 40px;
            margin-bottom: 20px;
            border-bottom: 2px solid #A0926B;
            padding-bottom: 8px;
        }

        h3 {
            font-family: 'Crimson Text', serif;
            font-size: 1.5em;
            color: #8B7D6B;
            margin-top: 30px;
            margin-bottom: 15px;
        }

        h4 {
            font-family: 'Crimson Text', serif;
            font-size: 1.25em;
            color: #6B4E3D;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        p {
            margin-bottom: 15px;
            text-align: justify;
        }

        ul, ol {
            margin-left: 30px;
            margin-bottom: 20px;
        }

        li {
            margin-bottom: 8px;
        }

        code {
            background-color: #EDE7D3;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
            color: #6B4E3D;
        }

        pre {
            background-color: #2D2A26;
            color: #F5F1E8;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 20px 0;
        }

        pre code {
            background-color: transparent;
            color: #F5F1E8;
            padding: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: #FFFFFF;
        }

        th, td {
            border: 1px solid #A0926B;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #8B7D6B;
            color: #FFFFFF;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background-color: #F5F1E8;
        }

        .info-box {
            background-color: #EDE7D3;
            border-left: 4px solid #8B7D6B;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .warning-box {
            background-color: #FFF4E6;
            border-left: 4px solid #A67C52;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .success-box {
            background-color: #E8F5E9;
            border-left: 4px solid #4A6741;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .toc {
            background-color: #EDE7D3;
            padding: 20px;
            border-radius: 8px;
            margin: 30px 0;
        }

        .toc ul {
            list-style-type: none;
            margin-left: 0;
        }

        .toc li {
            margin-bottom: 8px;
        }

        .toc a {
            color: #6B4E3D;
            text-decoration: none;
        }

        .toc a:hover {
            text-decoration: underline;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge-primary {
            background-color: #8B7D6B;
            color: #FFFFFF;
        }

        .footer {
            margin-top: 60px;
            padding-top: 20px;
            border-top: 2px solid #A0926B;
            text-align: center;
            color: #8B7D6B;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Membership Subscription Feature - Backend PRD <span class="badge badge-primary">v1.0</span></h1>

        <div class="info-box">
            <strong>Document Information:</strong><br>
            <strong>Version:</strong> 1.0<br>
            <strong>Date:</strong> 2025-01-27<br>
            <strong>Status:</strong> Implementation Ready<br>
            <strong>Project:</strong> Backend (Spring Boot)<br>
            <strong>Location:</strong> <code>E:\project_workspace\malayalees-us-site-boot</code><br>
            <strong>Frontend Project:</strong> <code>E:\project_workspace\mosc-temp</code>
        </div>

        <div class="warning-box">
            <strong>⚠️ Important Notes:</strong>
            <ul>
                <li>This project is already in active development - infrastructure, database schema, and basic tooling are complete</li>
                <li>Focus ONLY on feature implementation, NOT infrastructure setup</li>
                <li>Database tables <code>membership_plan</code> and <code>membership_subscription</code> already exist in <code>code_html_template/SQLS/Latest_Schema_Post__Blob_Claude_11.sql</code></li>
                <li>All API endpoints must follow Spring Data REST conventions</li>
                <li>All DTOs must match OpenAPI schema in <code>documentation/Swagger_API_Docs/api-docs.json</code></li>
                <li>Stripe integration infrastructure already exists - extend it for subscriptions</li>
            </ul>
        </div>

        <div class="toc">
            <h3>Table of Contents</h3>
            <ul>
                <li><a href="#overview">1. Overview</a></li>
                <li><a href="#database-schema">2. Database Schema</a></li>
                <li><a href="#api-endpoints">3. API Endpoints</a></li>
                <li><a href="#dto-schemas">4. DTO Schemas</a></li>
                <li><a href="#stripe-integration">5. Stripe Integration</a></li>
                <li><a href="#business-logic">6. Business Logic</a></li>
                <li><a href="#implementation">7. Implementation Tasks</a></li>
                <li><a href="#testing">8. Testing Requirements</a></li>
            </ul>
        </div>

        <h2 id="overview">1. Overview</h2>
        <p>This document specifies the <strong>backend implementation</strong> for the Membership Subscription feature. The backend will provide REST API endpoints for managing membership plans and subscriptions, integrate with Stripe for payment processing, and handle webhook events.</p>

        <h3>Key Backend Features</h3>
        <ul>
            <li><strong>Membership Plan CRUD API</strong>: Create, read, update, delete membership plans</li>
            <li><strong>Membership Subscription API</strong>: Create, read, update subscriptions</li>
            <li><strong>Stripe Integration</strong>: Create Stripe Products/Prices, manage subscriptions</li>
            <li><strong>Webhook Handling</strong>: Process Stripe subscription webhooks</li>
            <li><strong>Business Logic</strong>: Subscription lifecycle management, trial periods, upgrades/downgrades</li>
        </ul>

        <h3>Technical Stack</h3>
        <ul>
            <li><strong>Framework:</strong> Spring Boot</li>
            <li><strong>Database:</strong> PostgreSQL</li>
            <li><strong>ORM:</strong> Spring Data JPA / JHipster</li>
            <li><strong>API:</strong> Spring Data REST</li>
            <li><strong>Payment:</strong> Stripe Java SDK</li>
            <li><strong>Authentication:</strong> JWT (existing infrastructure)</li>
        </ul>

        <h2 id="database-schema">2. Database Schema</h2>

        <div class="success-box">
            <strong>✅ Database Tables Verified</strong>
            <p>The following tables already exist in <code>code_html_template/SQLS/Latest_Schema_Post__Blob_Claude_11.sql</code>:</p>
            <ul>
                <li><code>membership_plan</code> - Lines 4274-4298</li>
                <li><code>membership_subscription</code> - Lines 4314-4344</li>
            </ul>
        </div>

        <h3>2.1 membership_plan Table</h3>
        <p><strong>Purpose:</strong> Stores membership plan definitions</p>
        <p><strong>Key Fields:</strong></p>
        <ul>
            <li><code>id</code> - Primary key (bigint)</li>
            <li><code>tenant_id</code> - Tenant identifier (varchar)</li>
            <li><code>plan_name</code> - Plan display name (varchar)</li>
            <li><code>plan_code</code> - Unique plan code (varchar, unique per tenant)</li>
            <li><code>description</code> - Plan description (text)</li>
            <li><code>plan_type</code> - SUBSCRIPTION, ONE_TIME, FREEMIUM (varchar)</li>
            <li><code>billing_interval</code> - MONTHLY, QUARTERLY, YEARLY, ONE_TIME (varchar)</li>
            <li><code>price</code> - Plan price (numeric)</li>
            <li><code>currency</code> - Currency code, default USD (varchar)</li>
            <li><code>trial_days</code> - Number of trial days (integer, default 0)</li>
            <li><code>is_active</code> - Active status (boolean, default true)</li>
            <li><code>max_events_per_month</code> - Feature limit (integer, nullable)</li>
            <li><code>max_attendees_per_event</code> - Feature limit (integer, nullable)</li>
            <li><code>features_json</code> - JSON features object (jsonb)</li>
            <li><code>stripe_price_id</code> - Stripe Price ID (varchar, nullable)</li>
            <li><code>stripe_product_id</code> - Stripe Product ID (varchar, nullable)</li>
            <li><code>created_at</code> - Creation timestamp</li>
            <li><code>updated_at</code> - Update timestamp</li>
        </ul>
        <p><strong>Constraints:</strong></p>
        <ul>
            <li>Unique constraint: <code>unique_tenant_plan_code</code> on (tenant_id, plan_code)</li>
            <li>Check constraint: <code>check_plan_price</code> - price >= 0</li>
            <li>Check constraint: <code>check_billing_interval</code> - Valid values</li>
            <li>Check constraint: <code>check_plan_type</code> - Valid values</li>
        </ul>

        <h3>2.2 membership_subscription Table</h3>
        <p><strong>Purpose:</strong> Stores user subscription enrollments</p>
        <p><strong>Key Fields:</strong></p>
        <ul>
            <li><code>id</code> - Primary key (bigint)</li>
            <li><code>tenant_id</code> - Tenant identifier (varchar)</li>
            <li><code>user_profile_id</code> - Foreign key to user_profile (bigint)</li>
            <li><code>membership_plan_id</code> - Foreign key to membership_plan (bigint)</li>
            <li><code>subscription_status</code> - ACTIVE, TRIAL, CANCELLED, PAST_DUE, EXPIRED, SUSPENDED (varchar)</li>
            <li><code>current_period_start</code> - Current billing period start (date)</li>
            <li><code>current_period_end</code> - Current billing period end (date)</li>
            <li><code>trial_start</code> - Trial start date (date, nullable)</li>
            <li><code>trial_end</code> - Trial end date (date, nullable)</li>
            <li><code>cancel_at_period_end</code> - Cancel at period end flag (boolean)</li>
            <li><code>cancelled_at</code> - Cancellation timestamp (timestamp, nullable)</li>
            <li><code>cancellation_reason</code> - Cancellation reason (text, nullable)</li>
            <li><code>stripe_subscription_id</code> - Stripe Subscription ID (varchar, nullable)</li>
            <li><code>stripe_customer_id</code> - Stripe Customer ID (varchar, nullable)</li>
            <li><code>payment_provider_config_id</code> - Foreign key to payment_provider_config (bigint, nullable)</li>
            <li><code>created_at</code> - Creation timestamp</li>
            <li><code>updated_at</code> - Update timestamp</li>
        </ul>
        <p><strong>Constraints:</strong></p>
        <ul>
            <li>Foreign key: <code>fk_membership_subscription__user_profile_id</code> to user_profile</li>
            <li>Foreign key: <code>fk_membership_subscription__membership_plan_id</code> to membership_plan</li>
            <li>Foreign key: <code>fk_membership_subscription__payment_provider_config_id</code> to payment_provider_config</li>
            <li>Check constraint: <code>check_subscription_status</code> - Valid values</li>
            <li>Check constraint: <code>check_period_dates</code> - current_period_end >= current_period_start</li>
            <li>Check constraint: <code>check_trial_dates</code> - Valid trial date pairs</li>
        </ul>

        <h3>2.3 Required Indexes</h3>
        <p><strong>Performance Indexes:</strong></p>
        <pre><code>-- Membership Plan Indexes
CREATE INDEX IF NOT EXISTS idx_membership_plan_tenant_id
ON membership_plan(tenant_id);

CREATE INDEX IF NOT EXISTS idx_membership_plan_is_active
ON membership_plan(is_active) WHERE is_active = true;

CREATE INDEX IF NOT EXISTS idx_membership_plan_tenant_active
ON membership_plan(tenant_id, is_active);

-- Membership Subscription Indexes
CREATE INDEX IF NOT EXISTS idx_membership_subscription_user_profile_id
ON membership_subscription(user_profile_id);

CREATE INDEX IF NOT EXISTS idx_membership_subscription_tenant_id
ON membership_subscription(tenant_id);

CREATE INDEX IF NOT EXISTS idx_membership_subscription_status
ON membership_subscription(subscription_status);

CREATE INDEX IF NOT EXISTS idx_membership_subscription_stripe_subscription_id
ON membership_subscription(stripe_subscription_id) WHERE stripe_subscription_id IS NOT NULL;</code></pre>

        <h2 id="api-endpoints">3. API Endpoints</h2>

        <div class="info-box">
            <strong>✅ API Standards</strong>
            <p>All endpoints must follow Spring Data REST conventions and match the OpenAPI schema in <code>documentation/Swagger_API_Docs/api-docs.json</code>:</p>
            <ul>
                <li>Use JHipster/Spring Data REST filter syntax: <code>field.operation=value</code></li>
                <li>Support pagination: <code>page</code>, <code>size</code>, <code>sort</code></li>
                <li>Return <code>x-total-count</code> header for paginated responses</li>
                <li>Require JWT authentication for all endpoints</li>
                <li>Enforce tenant isolation at database level</li>
            </ul>
        </div>

        <h3>3.1 Membership Plan Endpoints</h3>

        <h4>GET /api/membership-plans</h4>
        <p><strong>Description:</strong> List all membership plans (with filtering)</p>
        <p><strong>Query Parameters:</strong></p>
        <ul>
            <li><code>tenantId.equals</code> (required) - Tenant ID filter</li>
            <li><code>isActive.equals</code> (optional) - Filter by active status</li>
            <li><code>planType.equals</code> (optional) - Filter by plan type</li>
            <li><code>billingInterval.equals</code> (optional) - Filter by billing interval</li>
            <li><code>sort</code> (optional) - Sort order (e.g., <code>price,asc</code>)</li>
            <li><code>page</code> (optional) - Page number (default: 0)</li>
            <li><code>size</code> (optional) - Page size (default: 20)</li>
        </ul>
        <p><strong>Response:</strong> Array of MembershipPlanDTO</p>
        <p><strong>Response Headers:</strong></p>
        <ul>
            <li><code>x-total-count</code> - Total count for pagination</li>
        </ul>

        <h4>GET /api/membership-plans/{id}</h4>
        <p><strong>Description:</strong> Get a specific membership plan by ID</p>
        <p><strong>Path Parameters:</strong></p>
        <ul>
            <li><code>id</code> (required) - Plan ID</li>
        </ul>
        <p><strong>Response:</strong> MembershipPlanDTO</p>

        <h4>POST /api/membership-plans</h4>
        <p><strong>Description:</strong> Create a new membership plan (admin only)</p>
        <p><strong>Request Body:</strong> MembershipPlanDTO</p>
        <p><strong>Business Logic:</strong></p>
        <ul>
            <li>Validate plan code uniqueness per tenant</li>
            <li>Create Stripe Product and Price if not provided</li>
            <li>Store Stripe IDs in plan record</li>
            <li>Set default values (isActive=true, currency=USD)</li>
        </ul>
        <p><strong>Response:</strong> MembershipPlanDTO (created)</p>

        <h4>PUT /api/membership-plans/{id}</h4>
        <p><strong>Description:</strong> Update an existing membership plan (admin only)</p>
        <p><strong>Path Parameters:</strong></p>
        <ul>
            <li><code>id</code> (required) - Plan ID</li>
        </ul>
        <p><strong>Request Body:</strong> MembershipPlanDTO</p>
        <p><strong>Business Logic:</strong></p>
        <ul>
            <li>Prevent updates to plans with active subscriptions (or handle gracefully)</li>
            <li>Update Stripe Product/Price if price or billing interval changes</li>
            <li>Validate plan code uniqueness if changed</li>
        </ul>
        <p><strong>Response:</strong> MembershipPlanDTO (updated)</p>

        <h4>PATCH /api/membership-plans/{id}</h4>
        <p><strong>Description:</strong> Partially update a membership plan (admin only)</p>
        <p><strong>Content-Type:</strong> <code>application/merge-patch+json</code></p>
        <p><strong>Request Body:</strong> Partial MembershipPlanDTO</p>
        <p><strong>Response:</strong> MembershipPlanDTO (updated)</p>

        <h4>DELETE /api/membership-plans/{id}</h4>
        <p><strong>Description:</strong> Delete a membership plan (admin only)</p>
        <p><strong>Path Parameters:</strong></p>
        <ul>
            <li><code>id</code> (required) - Plan ID</li>
        </ul>
        <p><strong>Business Logic:</strong></p>
        <ul>
            <li>Prevent deletion if plan has active subscriptions</li>
            <li>Soft delete by setting isActive=false (recommended)</li>
            <li>Or hard delete if no subscriptions exist</li>
        </ul>
        <p><strong>Response:</strong> 204 No Content</p>

        <h3>3.2 Membership Subscription Endpoints</h3>

        <h4>GET /api/membership-subscriptions</h4>
        <p><strong>Description:</strong> List all membership subscriptions (with filtering)</p>
        <p><strong>Query Parameters:</strong></p>
        <ul>
            <li><code>tenantId.equals</code> (required) - Tenant ID filter</li>
            <li><code>userProfileId.equals</code> (optional) - Filter by user</li>
            <li><code>membershipPlanId.equals</code> (optional) - Filter by plan</li>
            <li><code>subscriptionStatus.equals</code> (optional) - Filter by status</li>
            <li><code>sort</code> (optional) - Sort order</li>
            <li><code>page</code> (optional) - Page number</li>
            <li><code>size</code> (optional) - Page size</li>
        </ul>
        <p><strong>Response:</strong> Array of MembershipSubscriptionDTO</p>
        <p><strong>Response Headers:</strong></p>
        <ul>
            <li><code>x-total-count</code> - Total count for pagination</li>
        </ul>

        <h4>GET /api/membership-subscriptions/by-user/{userId}</h4>
        <p><strong>Description:</strong> Get user's active subscription</p>
        <p><strong>Path Parameters:</strong></p>
        <ul>
            <li><code>userId</code> (required) - User Profile ID</li>
        </ul>
        <p><strong>Response:</strong> MembershipSubscriptionDTO (or 404 if not found)</p>

        <h4>GET /api/membership-subscriptions/{id}</h4>
        <p><strong>Description:</strong> Get a specific subscription by ID</p>
        <p><strong>Path Parameters:</strong></p>
        <ul>
            <li><code>id</code> (required) - Subscription ID</li>
        </ul>
        <p><strong>Response:</strong> MembershipSubscriptionDTO</p>

        <h4>POST /api/membership-subscriptions</h4>
        <p><strong>Description:</strong> Create a new subscription (typically via webhook, not direct API)</p>
        <p><strong>Request Body:</strong> MembershipSubscriptionDTO</p>
        <p><strong>Business Logic:</strong></p>
        <ul>
            <li>Validate user profile exists</li>
            <li>Validate membership plan exists and is active</li>
            <li>Check for existing active subscription (prevent duplicates)</li>
            <li>Calculate trial period dates if applicable</li>
            <li>Set current period dates</li>
            <li>Set initial status (TRIAL if trial_days > 0, else ACTIVE)</li>
        </ul>
        <p><strong>Response:</strong> MembershipSubscriptionDTO (created)</p>

        <h4>PATCH /api/membership-subscriptions/{id}</h4>
        <p><strong>Description:</strong> Update subscription (e.g., cancel, upgrade, downgrade)</p>
        <p><strong>Content-Type:</strong> <code>application/merge-patch+json</code></p>
        <p><strong>Request Body:</strong> Partial MembershipSubscriptionDTO</p>
        <p><strong>Business Logic:</strong></p>
        <ul>
            <li>Handle subscription cancellation (set cancel_at_period_end=true)</li>
            <li>Handle subscription upgrades/downgrades</li>
            <li>Update Stripe subscription accordingly</li>
        </ul>
        <p><strong>Response:</strong> MembershipSubscriptionDTO (updated)</p>

        <h2 id="dto-schemas">4. DTO Schemas</h2>

        <div class="warning-box">
            <strong>⚠️ DTO Requirements</strong>
            <p>All DTOs must match the OpenAPI schema in <code>documentation/Swagger_API_Docs/api-docs.json</code>:</p>
            <ul>
                <li>DTOs must include all fields from database tables</li>
                <li>DTOs must include validation annotations</li>
                <li>DTOs must support JSON serialization/deserialization</li>
                <li>DTOs must include tenantId field for multi-tenant support</li>
            </ul>
        </div>

        <h3>4.1 MembershipPlanDTO</h3>
        <pre><code>public class MembershipPlanDTO {
    private Long id;

    @NotNull
    private String tenantId;

    @NotBlank
    @Size(max = 255)
    private String planName;

    @NotBlank
    @Size(max = 100)
    private String planCode;

    private String description;

    @NotNull
    @Pattern(regexp = "SUBSCRIPTION|ONE_TIME|FREEMIUM")
    private String planType = "SUBSCRIPTION";

    @NotNull
    @Pattern(regexp = "MONTHLY|QUARTERLY|YEARLY|ONE_TIME")
    private String billingInterval = "MONTHLY";

    @NotNull
    @DecimalMin(value = "0.0")
    private BigDecimal price;

    @NotNull
    @Size(min = 3, max = 3)
    private String currency = "USD";

    @Min(0)
    private Integer trialDays = 0;

    @NotNull
    private Boolean isActive = true;

    private Integer maxEventsPerMonth;

    private Integer maxAttendeesPerEvent;

    private Map&lt;String, Object&gt; featuresJson;

    private String stripePriceId;

    private String stripeProductId;

    private Instant createdAt;

    private Instant updatedAt;
}</code></pre>

        <h3>4.2 MembershipSubscriptionDTO</h3>
        <pre><code>public class MembershipSubscriptionDTO {
    private Long id;

    @NotNull
    private String tenantId;

    @NotNull
    private Long userProfileId;

    @NotNull
    private Long membershipPlanId;

    @NotNull
    @Pattern(regexp = "ACTIVE|TRIAL|CANCELLED|PAST_DUE|EXPIRED|SUSPENDED")
    private String subscriptionStatus = "ACTIVE";

    @NotNull
    private LocalDate currentPeriodStart;

    @NotNull
    private LocalDate currentPeriodEnd;

    private LocalDate trialStart;

    private LocalDate trialEnd;

    @NotNull
    private Boolean cancelAtPeriodEnd = false;

    private Instant cancelledAt;

    private String cancellationReason;

    private String stripeSubscriptionId;

    private String stripeCustomerId;

    private Long paymentProviderConfigId;

    private Instant createdAt;

    private Instant updatedAt;

    // Relations (optional, for expanded responses)
    private MembershipPlanDTO membershipPlan;

    private UserProfileDTO userProfile;
}</code></pre>

        <h2 id="stripe-integration">5. Stripe Integration</h2>

        <h3>5.1 Stripe Product and Price Creation</h3>
        <p><strong>When Creating Membership Plan:</strong></p>
        <ul>
            <li>Create Stripe Product with plan name and description</li>
            <li>Create Stripe Price with:
                <ul>
                    <li>Amount (in cents)</li>
                    <li>Currency</li>
                    <li>Recurring interval (month, quarter, year) or one-time</li>
                    <li>Product reference</li>
                </ul>
            </li>
            <li>Store Stripe Product ID and Price ID in membership_plan record</li>
        </ul>

        <h3>5.2 Stripe Subscription Creation</h3>
        <p><strong>When User Subscribes:</strong></p>
        <ul>
            <li>Create or retrieve Stripe Customer</li>
            <li>Create Stripe Subscription with:
                <ul>
                    <li>Customer ID</li>
                    <li>Price ID from membership plan</li>
                    <li>Trial period (if applicable)</li>
                    <li>Metadata (tenantId, userProfileId, membershipPlanId)</li>
                </ul>
            </li>
            <li>Store Stripe Subscription ID and Customer ID in membership_subscription record</li>
        </ul>

        <h3>5.3 Stripe Webhook Events</h3>
        <p><strong>Required Webhook Events:</strong></p>
        <ul>
            <li><code>checkout.session.completed</code> - Create subscription after payment</li>
            <li><code>customer.subscription.created</code> - Subscription created</li>
            <li><code>customer.subscription.updated</code> - Subscription updated (upgrade/downgrade)</li>
            <li><code>customer.subscription.deleted</code> - Subscription cancelled</li>
            <li><code>invoice.payment_succeeded</code> - Successful recurring payment</li>
            <li><code>invoice.payment_failed</code> - Failed payment (update status to PAST_DUE)</li>
        </ul>

        <h3>5.4 Webhook Handler Logic</h3>
        <p><strong>checkout.session.completed:</strong></p>
        <ul>
            <li>Extract metadata (tenantId, userProfileId, membershipPlanId)</li>
            <li>Retrieve Stripe Subscription from session</li>
            <li>Create membership_subscription record</li>
            <li>Set trial dates if applicable</li>
            <li>Set current period dates from Stripe subscription</li>
        </ul>

        <p><strong>customer.subscription.updated:</strong></p>
        <ul>
            <li>Find subscription by stripe_subscription_id</li>
            <li>Update current_period_start and current_period_end</li>
            <li>Update subscription status if changed</li>
            <li>Handle plan changes (upgrade/downgrade)</li>
        </ul>

        <p><strong>customer.subscription.deleted:</strong></p>
        <ul>
            <li>Find subscription by stripe_subscription_id</li>
            <li>Update subscription_status to CANCELLED</li>
            <li>Set cancelled_at timestamp</li>
        </ul>

        <p><strong>invoice.payment_failed:</strong></p>
        <ul>
            <li>Find subscription by stripe_subscription_id</li>
            <li>Update subscription_status to PAST_DUE</li>
            <li>Send notification to user (if applicable)</li>
        </ul>

        <h2 id="business-logic">6. Business Logic</h2>

        <h3>6.1 Subscription Lifecycle</h3>
        <p><strong>Status Transitions:</strong></p>
        <ul>
            <li><code>TRIAL</code> → <code>ACTIVE</code> (when trial ends and payment succeeds)</li>
            <li><code>ACTIVE</code> → <code>PAST_DUE</code> (when payment fails)</li>
            <li><code>PAST_DUE</code> → <code>ACTIVE</code> (when payment succeeds)</li>
            <li><code>ACTIVE</code> → <code>CANCELLED</code> (when user cancels)</li>
            <li><code>CANCELLED</code> → <code>EXPIRED</code> (when period ends)</li>
        </ul>

        <h3>6.2 Trial Period Logic</h3>
        <ul>
            <li>If membership_plan.trial_days > 0:
                <ul>
                    <li>Set subscription_status to TRIAL</li>
                    <li>Set trial_start to current date</li>
                    <li>Set trial_end to current date + trial_days</li>
                    <li>Set current_period_start to trial_start</li>
                    <li>Set current_period_end to trial_end</li>
                </ul>
            </li>
            <li>When trial ends:
                <ul>
                    <li>Stripe automatically charges customer</li>
                    <li>On successful payment, update subscription_status to ACTIVE</li>
                    <li>Set current_period_start to trial_end</li>
                    <li>Set current_period_end based on billing_interval</li>
                </ul>
            </li>
        </ul>

        <h3>6.3 Subscription Cancellation</h3>
        <ul>
            <li>User cancels subscription:
                <ul>
                    <li>Set cancel_at_period_end = true</li>
                    <li>Set cancellation_reason (if provided)</li>
                    <li>Cancel Stripe subscription at period end</li>
                    <li>Subscription remains ACTIVE until period_end</li>
                </ul>
            </li>
            <li>When period ends:
                <ul>
                    <li>Stripe webhook: customer.subscription.deleted</li>
                    <li>Update subscription_status to CANCELLED</li>
                    <li>Set cancelled_at timestamp</li>
                </ul>
            </li>
        </ul>

        <h3>6.4 Subscription Upgrades/Downgrades</h3>
        <ul>
            <li>User upgrades/downgrades:
                <ul>
                    <li>Create new Stripe Subscription with new Price ID</li>
                    <li>Cancel old Stripe Subscription</li>
                    <li>Create new membership_subscription record</li>
                    <li>Set old subscription status to CANCELLED</li>
                    <li>Prorate billing if applicable</li>
                </ul>
            </li>
        </ul>

        <h2 id="implementation">7. Implementation Tasks</h2>

        <h3>Phase 1: Entity & Repository (Week 1)</h3>
        <ol>
            <li><strong>Verify/Create JPA Entities</strong>
                <ul>
                    <li>Verify <code>MembershipPlan</code> entity matches database schema</li>
                    <li>Verify <code>MembershipSubscription</code> entity matches database schema</li>
                    <li>Add relationships (@ManyToOne, @OneToMany)</li>
                    <li>Add validation annotations</li>
                </ul>
            </li>
            <li><strong>Create Repositories</strong>
                <ul>
                    <li><code>MembershipPlanRepository</code> extends JpaRepository</li>
                    <li><code>MembershipSubscriptionRepository</code> extends JpaRepository</li>
                    <li>Add custom query methods (findByUserProfileId, findByTenantId, etc.)</li>
                </ul>
            </li>
        </ol>

        <h3>Phase 2: DTOs & Mappers (Week 1)</h3>
        <ol>
            <li><strong>Create DTOs</strong>
                <ul>
                    <li><code>MembershipPlanDTO</code> - Match OpenAPI schema</li>
                    <li><code>MembershipSubscriptionDTO</code> - Match OpenAPI schema</li>
                    <li>Add validation annotations</li>
                </ul>
            </li>
            <li><strong>Create Mappers</strong>
                <ul>
                    <li><code>MembershipPlanMapper</code> - Entity ↔ DTO</li>
                    <li><code>MembershipSubscriptionMapper</code> - Entity ↔ DTO</li>
                    <li>Use MapStruct or manual mapping</li>
                </ul>
            </li>
        </ol>

        <h3>Phase 3: Service Layer (Week 2)</h3>
        <ol>
            <li><strong>Create MembershipPlanService</strong>
                <ul>
                    <li>CRUD operations</li>
                    <li>Stripe Product/Price creation</li>
                    <li>Validation logic</li>
                </ul>
            </li>
            <li><strong>Create MembershipSubscriptionService</strong>
                <ul>
                    <li>Subscription creation</li>
                    <li>Subscription updates</li>
                    <li>Subscription cancellation</li>
                    <li>Trial period calculation</li>
                    <li>Period date calculation</li>
                </ul>
            </li>
            <li><strong>Create StripeSubscriptionService</strong>
                <ul>
                    <li>Stripe Customer creation/retrieval</li>
                    <li>Stripe Subscription creation</li>
                    <li>Stripe Subscription updates</li>
                    <li>Stripe Subscription cancellation</li>
                </ul>
            </li>
        </ol>

        <h3>Phase 4: REST Controllers (Week 2)</h3>
        <ol>
            <li><strong>Create MembershipPlanResource</strong>
                <ul>
                    <li>GET /api/membership-plans</li>
                    <li>GET /api/membership-plans/{id}</li>
                    <li>POST /api/membership-plans</li>
                    <li>PUT /api/membership-plans/{id}</li>
                    <li>PATCH /api/membership-plans/{id}</li>
                    <li>DELETE /api/membership-plans/{id}</li>
                </ul>
            </li>
            <li><strong>Create MembershipSubscriptionResource</strong>
                <ul>
                    <li>GET /api/membership-subscriptions</li>
                    <li>GET /api/membership-subscriptions/by-user/{userId}</li>
                    <li>GET /api/membership-subscriptions/{id}</li>
                    <li>POST /api/membership-subscriptions</li>
                    <li>PATCH /api/membership-subscriptions/{id}</li>
                </ul>
            </li>
        </ol>

        <h3>Phase 5: Webhook Handler (Week 3)</h3>
        <ol>
            <li><strong>Enhance Stripe Webhook Handler</strong>
                <ul>
                    <li>Handle checkout.session.completed</li>
                    <li>Handle customer.subscription.created</li>
                    <li>Handle customer.subscription.updated</li>
                    <li>Handle customer.subscription.deleted</li>
                    <li>Handle invoice.payment_succeeded</li>
                    <li>Handle invoice.payment_failed</li>
                </ul>
            </li>
            <li><strong>Add Webhook Logic</strong>
                <ul>
                    <li>Verify webhook signatures</li>
                    <li>Extract metadata</li>
                    <li>Create/update subscription records</li>
                    <li>Handle errors gracefully</li>
                </ul>
            </li>
        </ol>

        <h3>Phase 6: Billing Endpoint Enhancement (Week 3)</h3>
        <ol>
            <li><strong>Enhance /api/billing/manage-subscription</strong>
                <ul>
                    <li>Support subscription creation</li>
                    <li>Create Stripe Checkout Session for subscriptions</li>
                    <li>Return checkout session URL</li>
                </ul>
            </li>
        </ol>

        <h2 id="testing">8. Testing Requirements</h2>

        <h3>8.1 Unit Testing</h3>
        <ul>
            <li>Test service layer methods</li>
            <li>Test business logic (trial periods, cancellations, upgrades)</li>
            <li>Test DTO validation</li>
            <li>Test mapper conversions</li>
        </ul>

        <h3>8.2 Integration Testing</h3>
        <ul>
            <li>Test REST endpoints</li>
            <li>Test database operations</li>
            <li>Test Stripe integration (use test mode)</li>
            <li>Test webhook handlers</li>
        </ul>

        <h3>8.3 E2E Testing</h3>
        <ul>
            <li>Test complete subscription flow</li>
            <li>Test webhook processing</li>
            <li>Test subscription management</li>
            <li>Test multi-tenant isolation</li>
        </ul>

        <h2 id="references">9. Key References</h2>

        <div class="success-box">
            <h3>Documentation References</h3>
            <ul>
                <li><strong>Database Schema:</strong> <code>code_html_template/SQLS/Latest_Schema_Post__Blob_Claude_11.sql</code></li>
                <li><strong>OpenAPI Schema:</strong> <code>documentation/Swagger_API_Docs/api-docs.json</code></li>
                <li><strong>Stripe Docs:</strong> <a href="https://stripe.com/docs/billing/subscriptions/overview" target="_blank">Subscriptions</a></li>
                <li><strong>Stripe Docs:</strong> <a href="https://stripe.com/docs/webhooks" target="_blank">Webhooks</a></li>
            </ul>

            <h3>Frontend Project</h3>
            <ul>
                <li><strong>Location:</strong> <code>E:\project_workspace\mosc-temp</code></li>
                <li><strong>API Base URL:</strong> Configured in frontend environment</li>
            </ul>

            <h3>Existing Infrastructure</h3>
            <ul>
                <li>Stripe integration already exists - extend for subscriptions</li>
                <li>JWT authentication already exists</li>
                <li>Multi-tenant support already exists</li>
                <li>Webhook handler already exists - enhance for subscription events</li>
            </ul>
        </div>

        <div class="footer">
            <p><strong>Membership Subscription Feature - Backend PRD</strong></p>
            <p>Version 1.0 | Date: 2025-01-27</p>
            <p>Backend Project: <code>E:\project_workspace\malayalees-us-site-boot</code></p>
        </div>
    </div>
</body>
</html>



